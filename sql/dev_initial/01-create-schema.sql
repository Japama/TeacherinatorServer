---- Base app schema

-- Users
CREATE TABLE "users"
(
    id            BIGINT GENERATED BY DEFAULT AS IDENTITY (START WITH 1000) PRIMARY KEY,
    username      varchar(128)             NOT NULL UNIQUE,
    isadmin       bool                     NOT NULL DEFAULT false,

    -- Auth
    pwd           varchar(256),
    pwd_salt      uuid                     NOT NULL DEFAULT gen_random_uuid(),
    token_salt    uuid                     NOT NULL DEFAULT gen_random_uuid(),

    -- Timestamps
    cid           bigint                   NOT NULL,
    ctime         timestamp with time zone NOT NULL,
    mid           bigint                   NOT NULL,
    mtime         timestamp with time zone NOT NULL
);

-- Departments
CREATE TABLE "departments"
(
    id    BIGINT GENERATED BY DEFAULT AS IDENTITY (START WITH 1000) PRIMARY KEY,
    name  varchar(256)             NOT NULL UNIQUE,


    -- Timestamps
    cid   bigint                   NOT NULL,
    ctime timestamp with time zone NOT NULL,
    mid   bigint                   NOT NULL,
    mtime timestamp with time zone NOT NULL
);

-- Teachers
CREATE TABLE "teachers"
(
    id            BIGINT GENERATED BY DEFAULT AS IDENTITY (START WITH 1000) PRIMARY KEY,
    user_id       BIGINT REFERENCES users (id) ON DELETE CASCADE NOT NULL UNIQUE,
    active        bool,
    department_id BIGINT                   NOT NULL,
--     substituting  BIGINT                   UNIQUE,

    -- Timestamps
    cid           bigint                   NOT NULL,
    ctime         timestamp with time zone NOT NULL,
    mid           bigint                   NOT NULL,
    mtime         timestamp with time zone NOT NULL,

    FOREIGN KEY (department_id) REFERENCES departments (id)
);

-- Subjects
CREATE TABLE "subjects"
(
    id               BIGINT GENERATED BY DEFAULT AS IDENTITY (START WITH 1000) PRIMARY KEY,
    name             varchar(256)             NOT NULL,
    department_id    BIGINT                   NOT NULL DEFAULT 0,
    is_guard         bool                     NOT NULL DEFAULT false,
    is_complementary bool                     NOT NULL DEFAULT false,

    -- Timestamps
    cid             bigint                   NOT NULL,
    ctime           timestamp with time zone NOT NULL,
    mid             bigint                   NOT NULL,
    mtime           timestamp with time zone NOT NULL,

    FOREIGN KEY (department_id) REFERENCES departments (id)
);


-- Groups
CREATE TABLE "groups"
(
    id       BIGINT GENERATED BY DEFAULT AS IDENTITY (START WITH 1000) PRIMARY KEY,
    course   int                      NOT NULL, -- 2024/2025
    stage    int                      NOT NULL, -- ESO, BACHILLER, FP
    year     int                      NOT NULL, -- 1ยบ, 2ยบ
    letter   varchar(10)              NOT NULL, -- A, B, C
    tutor_id BIGINT                   NOT NULL,

    -- Timestamps
    cid      bigint                   NOT NULL,
    ctime    timestamp with time zone NOT NULL,
    mid      bigint                   NOT NULL,
    mtime    timestamp with time zone NOT NULL,

    UNIQUE (course, stage, year, letter)
);

-- Room
CREATE TABLE "classrooms"
(
    id          BIGINT GENERATED BY DEFAULT AS IDENTITY (START WITH 1000) PRIMARY KEY,
    building    varchar(20),
    floor       int,
    number      int,
    name        varchar(20)             UNIQUE,
    type_c      int,
    description varchar(256),

    -- Timestamps
    cid         bigint                   NOT NULL,
    ctime       timestamp with time zone NOT NULL,
    mid         bigint                   NOT NULL,
    mtime       timestamp with time zone NOT NULL,

    UNIQUE (building, floor, number)
);


-- Schedules
CREATE TABLE schedules
(
    id            BIGINT GENERATED BY DEFAULT AS IDENTITY (START WITH 1000),
    teacher_id    BIGINT REFERENCES teachers (id) ON DELETE CASCADE,
    group_id      BIGINT REFERENCES groups (id),
    course        INT                          NOT NULL, -- 2024/2025

    -- Timestamps
    cid           bigint                       NOT NULL,
    ctime         timestamp with time zone     NOT NULL,
    mid           bigint                       NOT NULL,
    mtime         timestamp with time zone     NOT NULL,
    PRIMARY KEY (id, course),
    UNIQUE (group_id, course),
    UNIQUE (teacher_id, course)
) PARTITION BY RANGE (course);

CREATE TABLE schedules_2022 PARTITION OF schedules FOR VALUES FROM (2022) TO (2023);
CREATE TABLE schedules_2023 PARTITION OF schedules FOR VALUES FROM (2023) TO (2024);
CREATE TABLE schedules_2024 PARTITION OF schedules FOR VALUES FROM (2024) TO (2025);
CREATE TABLE schedules_2025 PARTITION OF schedules FOR VALUES FROM (2025) TO (2026);

-- Schedule_hora
CREATE TABLE schedule_hours
(
    id            BIGINT GENERATED BY DEFAULT AS IDENTITY (START WITH 1000),
    schedule_id   BIGINT                       NOT NULL,
    subject_id    BIGINT REFERENCES subjects (id) NOT NULL,
    week_day      INT                          NOT NULL,
    n_hour        INT                          NOT NULL,
    start_time    TIME NOT NULL,
    end_time      TIME NOT NULL,
    course        INT                          NOT NULL,

    -- Timestamps
    cid           bigint                       NOT NULL,
    ctime         timestamp with time zone     NOT NULL,
    mid           bigint                       NOT NULL,
    mtime         timestamp with time zone     NOT NULL,
    PRIMARY KEY (id, course),
    FOREIGN KEY (schedule_id, course) REFERENCES schedules (id, course) ON DELETE CASCADE,
    UNIQUE (schedule_id, course, week_day, n_hour)
) PARTITION BY RANGE (course);


CREATE TABLE schedule_hours_2022 PARTITION OF schedule_hours FOR VALUES FROM (2022) TO (2023);
CREATE TABLE schedule_hours_2023 PARTITION OF schedule_hours FOR VALUES FROM (2023) TO (2024);
CREATE TABLE schedule_hours_2024 PARTITION OF schedule_hours FOR VALUES FROM (2024) TO (2025);
CREATE TABLE schedule_hours_2025 PARTITION OF schedule_hours FOR VALUES FROM (2025) TO (2026);
